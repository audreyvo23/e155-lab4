// main.c
// GPIO blink LED with clock configuration
// Josh Brake
// jbrake@hmc.edu
// 9/16/24

// Includes for libraries
#include "lib/STM32L432KC_RCC.h"
#include "lib/STM32L432KC_GPIO.h"
#include "lib/STM32L432KC_FLASH.h"
#include "lib/STM32L432KC_TIM.h"

// Define macros for constants
#define LED_PIN           9
#define DELAY_DURATION_MS    500
#define ALT_FUNC          6

const int brat[][2] = {
{294,   250},
{247,   375},
{0, 2000},
{247,   250},
{294,   250},
{330,   250},
{370,   250},
{330,   250},
{294,   250},
{0, 31},
{294,   250},
{247,   250},
{0, 31},
{247,   250},
{294,   250},
{330,   250},
{370,   250},
{554,   375},
{0, 125},
{440,   375},
{0, 375},
{330,   500},
{0, 250},
{370,   500},
{  0,   250},
{294,   250},
{247,   375},
{0, 2000},
//here
{247,   250},
{294,   250},
{330,   250},
{370,   250},
{330,   250},
{294,   250},
{0, 31},
{294,   250},
{247,   250},
{0, 31},
{247,  250},
{294,   250},
{330,   250},
{370,   250},
{554,   375},
{0, 125},
{440,   375},
{0, 375},
{330,   375},
{0, 375},
{370, 375},
{  0,   0}};

// Pitch in Hz, duration in ms
const int notes[][2] = {
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	250},
{  0,	125},
{494,	125},
{523,	125},
{587,	125},
{659,	375},
{392,	125},
{699,	125},
{659,	125},
{587,	375},
{349,	125},
{659,	125},
{587,	125},
{523,	375},
{330,	125},
{587,	125},
{523,	125},
{494,	250},
{  0,	125},
{330,	125},
{659,	125},
{  0,	250},
{659,	125},
{1319,	125},
{  0,	250},
{623,	125},
{659,	125},
{  0,	250},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	500},
{  0,	0}};


int main(void) {

    // enable timer 16 (pg 244)
    RCC->APB2ENR |= (1 << 17);
     // enable timer 15 (pg 244)
    RCC->APB2ENR |= (1 << 16);
    //enable GPIOA (pg 245)
    RCC->AHB2ENR |= (1 << 0);
   

  initTIMduration(TIM15);
  initTIMpwm(TIM16);
    
   // configure alternate function
    pinMode(ALT_FUNC, GPIO_ALT);

    // set alternate function to 14 on pin 6
    GPIO->AFRL |= (0b1110 << 24);

    // Set LED_PIN as output to test duration
    pinMode(LED_PIN, GPIO_OUTPUT);
    
   /*
    // play fur elise
    for(int i = 0; i < 108; i++) {
      setPitch(TIM16, notes[i][0]);
      delay_millis(TIM15, notes[i][1]);
      
    } */

    // play brat
      for(int i = 0; i < 50; i++) {
      setPitch(TIM16, brat[i][0]);
      delay_millis(TIM15, brat[i][1]);
      
    }

   // test LED
    while(1) {
       delay_millis(TIM15,DELAY_DURATION_MS);
        togglePin(LED_PIN);
    }


    return 0;


}